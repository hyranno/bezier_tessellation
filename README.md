# Tessellating Curves-Defined Triangle

辺となる3つの曲線で定義される三角形曲面パッチと、それをテセレートするためのアルゴリズムの提案。
対象読者として、シェーダでのテセレーションの基礎知識があることを想定しています。Bezier CurveとBezier Triangleについても適宜調べてください。
関係するコードは主に mesh.rs と curves_defined_triangle_tessellation.glsl.tese に書かれているので、実装の詳細についてはそちらを。

```cargo run [shape]``` でサンプルを見ることができます。shapeはdome/pyramid/cylinder/coneがあります。

## 特徴
* 曲面が滑らかに接続する場合もそうでない場合も、同様のデータ形式やアルゴリズムで処理する

* 三角形パッチのテセレーションには、そのパッチの情報のみを扱い、隣接パッチ等の情報は利用しない

* 2つの三角形パッチが辺を共有し、その辺での法線が一致しないときでも、亀裂を生じない

* 2つの三角形パッチが辺を共有し、その辺の端点での法線が等しいとき、その辺では法線が連続する


## 概説
### Point-Normal Triangleの問題点
三角形曲面パッチのテセレートで代表的な方法としてPoint-Normal Triangleがある。これは三角形の頂点と、その頂点での法線から曲面を定義する。Point-Normal TriangleはCubic Bezier Triangleの特殊化で、Bezier Triangleの制御点が頂点と法線から決定される。

<img src="./assets/pn-triangle.svg" width=300 />

Point-Normal Triangleではパッチどうしの接続面にやや難があった。2点を共有するパッチどうしであっても、その2点における法線が一致しない場合は、2点を繋ぐ辺が一致せず、亀裂を生じてしまう。また、法線が一致する場合でも、法線が連続するのはその2点のみで、2点を繋ぐ辺の上では法線が不連続となった。

亀裂については隣接する辺の法線を利用する方法(PN-AEN)が提案されている。しかし隣接する辺を探してくるというのはあまり効率的ではないように思う。

辺での不連続な法線についても、滑らかな曲面を目指すなら修正したい。
ただ、実際の形状の法線ではなく連続に補間したライティング用の法線を使えば目立たなくすることはできるし、テセレーションで出てくるのはどうせ平面三角形パッチの集合なので、それほど問題ではない。

これらの課題を踏まえて、新しく三角形曲面パッチの定義とそのテセレーション方法を考える。

### 提案

まず、三角形パッチは辺となる3つの曲線で定義されるものとする。頂点ではなく辺を共有していれば亀裂が発生することは無いし、頂点とその法線よりも形状に自由が効く。今回は特に曲線にCubic Bezier Triangleを採用する。

また、辺での法線は、辺の曲線そのものとその両端での法線のみから決定されるものとする。こうすれば隣接パッチの情報を利用することなく、辺を共有する場合の法線連続を確保できる。今回は両端の法線を線形補間し、正規化したものを辺での法線として採用する。

<img src="./assets/curves-defined-triangle.svg" width=300 />

これをテセレーションするには、各辺の上の点と法線を求め、それらをPoint-Normal Triangleで補間する。細かい式はコードを見てください。

<img src="./assets/inner-pn-triangle.svg" width=400 />


## Tips
### ある点での法線を定めたい
曲線をBezier Curveとして定義する場合、その点と隣接する制御点が、その点での接平面上にあればよい。

### 辺を共有していても亀裂が生じる
曲面の問題ではなく、辺の分割数が一致していないのでは。Tessellation Control Shaderにおいて、gl_TessLevelOuterを曲面全体ではなく辺の情報(長さなど)で決定する。UnityだとTessellation.cgincにあるUnityEdgeLengthBasedTessなど。

### 形状の法線連続は気にしないのでもっと単純化したい
曲線がCubic Bezier Curveの場合は、中央の制御点を補間すればそのままCubic Bezier Triangleにできる。または三角形パッチの定義を3つの辺(曲線)と1つの制御点にしてもよい。


## 課題
### ファイル形式
現状において一般的なファイル形式では面を辺ではなく頂点の集合で定義している。辺の集合での定義に対応するファイル形式を用意する必要がある。

### DCCツール対応
DCCツールはベジエ曲線やNURBS曲線には対応しているが、それらから曲面を構成する機能はデフォルトでは無さそう。拡張機能等で曲線による面の定義とレンダリング、ファイル出力に対応させる必要がある。




